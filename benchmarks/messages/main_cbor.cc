#include "message.h"
#include <benchmark/benchmark.h>
#include <string.h>

static uint8_t CBOR_STRING[] = {
    0xa4, 0x67, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x02, 0x64, 0x75, 0x75, 0x69, 0x64, 0x78,
    0x24, 0x32, 0x44, 0x36, 0x44, 0x30, 0x32, 0x33, 0x31, 0x2d, 0x36, 0x44, 0x39, 0x31, 0x2d, 0x34,
    0x34, 0x36, 0x44, 0x2d, 0x38, 0x36, 0x44, 0x44, 0x2d, 0x38, 0x38, 0x44, 0x42, 0x37, 0x39, 0x45,
    0x41, 0x35, 0x45, 0x44, 0x46, 0x63, 0x75, 0x72, 0x69, 0x6e, 0x31, 0x32, 0x37, 0x2e, 0x30, 0x2e,
    0x30, 0x2e, 0x31, 0x3a, 0x38, 0x30, 0x30, 0x30, 0x67, 0x75, 0x70, 0x64, 0x61, 0x74, 0x65, 0x73
};

static uint8_t CBOR_SINGLE_UPDATE[] = {
    0xa4, 0x64, 0x75, 0x75, 0x69, 0x64, 0x78, 0x24, 0x30, 0x36, 0x36, 0x36, 0x43, 0x46,
    0x38, 0x44, 0x2d, 0x34, 0x42, 0x46, 0x42, 0x2d, 0x34, 0x38, 0x45, 0x34, 0x2d, 0x39,
    0x32, 0x32, 0x32, 0x2d, 0x42, 0x45, 0x46, 0x43, 0x34, 0x41, 0x45, 0x37, 0x41, 0x42,
    0x45, 0x30, 0x63, 0x75, 0x72, 0x69, 0x6e, 0x31, 0x32, 0x37, 0x2e, 0x30, 0x2e, 0x30,
    0x2e, 0x31, 0x3a, 0x39, 0x30, 0x30, 0x30, 0x66, 0x73, 0x74, 0x61, 0x74, 0x75, 0x73,
    0x00, 0x6b, 0x69, 0x6e, 0x63, 0x61, 0x72, 0x6e, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x00
};

static void BENCHMARK_microswim_cbor_decoding(benchmark::State& state) {
    microswim_message_t message;
    uint8_t buffer[BUFFER_SIZE] = { 0 };
    int offset = 0;
    memcpy(buffer, CBOR_STRING, sizeof(CBOR_STRING));
    offset += sizeof(CBOR_STRING);
    buffer[offset++] = (unsigned char)state.range(1);
    for (int i = 0; i < state.range(0); i++) {
        memcpy(buffer + offset, CBOR_SINGLE_UPDATE, sizeof(CBOR_SINGLE_UPDATE));
        offset += sizeof(CBOR_SINGLE_UPDATE);
    }

    for (auto _ : state) {
        microswim_cbor_decode_message(&message, buffer, sizeof(buffer));
    }
}

static void BENCHMARK_microswim_cbor_encoding(benchmark::State& state) {
    microswim_message_t message;
    uint8_t buffer[BUFFER_SIZE] = { 0 };
    int offset = 0;
    memcpy(buffer, CBOR_STRING, sizeof(CBOR_STRING));
    offset += sizeof(CBOR_STRING);
    buffer[offset++] = (unsigned char)state.range(1);
    for (int i = 0; i < state.range(0); i++) {
        memcpy(buffer + offset, CBOR_SINGLE_UPDATE, sizeof(CBOR_SINGLE_UPDATE));
        offset += sizeof(CBOR_SINGLE_UPDATE);
    }
    microswim_cbor_decode_message(&message, buffer, sizeof(buffer));

    for (auto _ : state) {
        unsigned char buffer[BUFFER_SIZE] = { 0 };
        size_t len = microswim_cbor_encode_message(&message, buffer, BUFFER_SIZE);
    }
}

BENCHMARK(BENCHMARK_microswim_cbor_decoding)
    ->Args({ 1, 0x81 })
    ->Args({ 2, 0x82 })
    ->Args({ 3, 0x83 })
    ->Args({ 4, 0x84 })
    ->Args({ 5, 0x85 })
    ->Args({ 6, 0x86 })
    ->Args({ 7, 0x87 })
    ->Args({ 8, 0x88 })
    ->Args({ 9, 0x89 });

BENCHMARK(BENCHMARK_microswim_cbor_encoding)
    ->Args({ 1, 0x81 })
    ->Args({ 2, 0x82 })
    ->Args({ 3, 0x83 })
    ->Args({ 4, 0x84 })
    ->Args({ 5, 0x85 })
    ->Args({ 6, 0x86 })
    ->Args({ 7, 0x87 })
    ->Args({ 8, 0x88 })
    ->Args({ 9, 0x89 });

BENCHMARK_MAIN();
